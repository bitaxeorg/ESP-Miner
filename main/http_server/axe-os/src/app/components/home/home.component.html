<ng-template #noValue>{{ 'common.no_value' | t }}</ng-template>

<ng-template #powerFault>
    <span class="text-red-500">
        {{ 'messages.power_fault_unavailable' | t }}
    </span>
</ng-template>

<ng-container *ngIf="info$ | async as info">
    <ng-container *ngFor="let message of messages">
        <p-message
            [severity]="message.severity"
            [text]="message.text"
            [styleClass]="'w-full mb-3 py-3 border-round-lg'"
        />
    </ng-container>

    <p-message *ngIf="info.blockFound" severity="success" styleClass="w-full mb-4 py-4 border-round-xl"
        [text]="'messages.block_found' | t">
    </p-message>

    <div class="grid">
        <div class="col-12 md:col-6 xl:col-3">
            <div class="card mb-0">
                <div class="flex flex-column justify-content-between">
                    <span class="block text-lg font-medium mb-3">{{ 'miner.hashrate' | t }}</span>

                    <ng-container *ngIf="!info.power_fault; else powerFault">
                        <div class="flex align-items-center justify-content-between gap-2 mb-3">
                            <span class="text-900 font-medium text-2xl white-space-nowrap">
                                {{info.hashRate | hashSuffix}}
                            </span>
                            <table class="text-sm">
                                <thead>
                                    <tr>
                                        <th class="p-0 text-400 font-normal line-height-1">
                                            <tooltip-text-icon class="pl-2"
                                                [text]="'common.error' | t"
                                                [tooltip]="'miner.hash_error_help' | t"
                                            />
                                        </th>
                                        <th *ngIf="info.expectedHashrate" class="p-0 pl-3 text-400 font-normal line-height-1">
                                            {{ 'common.expected' | t }}
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td class="p-0 text-center text-800 line-height-1">
                                            {{info.errorPercentage | number: '1.2-2'}}%
                                        </td>
                                        <td *ngIf="info.expectedHashrate" class="p-0 pl-3 text-center text-800 line-height-1 white-space-nowrap">
                                            {{info.expectedHashrate | hashSuffix: { tickmark: true } }}
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <table class="px-1 border-1 border-50 border-round-xs">
                            <thead>
                                <tr>
                                    <th *ngFor="let i of hashrateAverages" class="p-0 text-500 font-normal line-height-1">
                                        {{i.label}}
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td *ngFor="let i of hashrateAverages" class="p-0 text-center text-green-500 font-medium">
                                        {{ info[i.key] | hashSuffix }}
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </ng-container>
                </div>
            </div>
        </div>
        <div class="col-12 md:col-6 xl:col-3">
            <div class="card mb-0">
                <div class="flex flex-column justify-content-between">
                    <span class="block text-lg font-medium mb-3">{{ 'miner.efficiency' | t }}</span>

                    <ng-container *ngIf="!info.power_fault; else powerFault">
                        <div class="flex align-items-center justify-content-between gap-2 mb-3">
                            <span class="text-900 font-medium text-2xl white-space-nowrap">
                                {{getEfficiency(info) | number: '1.2-2'}} J/Th
                            </span>
                            <table class="text-sm">
                                <thead>
                                    <tr>
                                        <th class="p-0 text-400 font-normal line-height-1">
                                            {{ 'common.expected' | t }}
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td class="p-0 text-center text-800 line-height-1 white-space-nowrap">
                                            {{getExpectedEfficiency(info) | number: '1.2-2'}} J/Th
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div>
                            <span class="text-green-500 font-medium white-space-nowrap">
                                {{getEfficiencyAverage() | number: '1.2-2'}} J/Th
                            </span>
                            <span class="text-500">
                                {{ 'common.average' | t }}
                            </span>
                        </div>
                    </ng-container>
                </div>
            </div>
        </div>
        <div class="col-12 md:col-6 xl:col-3">
            <div class="card mb-0">
                <div class="flex justify-content-between mb-3">
                    <div>
                        <span class="block text-lg font-medium mb-3">{{ 'miner.shares' | t }}</span>
                        <div class="text-900 font-medium text-2xl">
                            {{info.sharesAccepted | number: '1.0-0'}}
                        </div>
                    </div>
                </div>
                <div *ngIf="info.sharesRejected === 0">
                    <span class="text-red-500 font-medium">0 </span>
                    <span class="text-500">{{ 'miner.rejected' | t }}</span>
                </div>
                <ng-container *ngIf="info.sharesRejected > 0">
                    <div *ngFor="let sharesRejectedReason of getSortedRejectionReasons(info); trackBy: trackByReason">
                        <span class="text-red-500 font-medium">
                            {{ sharesRejectedReason.count | number: '1.0-0' }}
                        </span>
                        <span class="text-500">
                            {{ getRejectionLabel(sharesRejectedReason.message) }}
                        </span>
                        <tooltip-text-icon
                            [text]="'(' + (getShareRejectionPercentage(sharesRejectedReason, info) | number:'1.2-2') + ' %)'"
                            [tooltip]="getRejectionExplanation(sharesRejectedReason.message)"
                            [split]=false />
                    </div>
                </ng-container>
            </div>
        </div>

        <div class="col-12 md:col-6 xl:col-3">
            <div class="card mb-0">
                <div class="flex justify-content-between mb-3">
                    <div>
                        <span class="block text-lg font-medium mb-3">{{ 'miner.best_difficulty' | t }}</span>
                        <div class="text-900 font-medium text-2xl">
                            <span class="cursor-pointer" pTooltip="{{info.bestDiff | number:'1.0-0'}}" tooltipPosition="bottom">
                                {{info.bestDiff | diffSuffix}}
                            </span>
                            <span class="text-500 text-lg">{{ 'miner.all_time_best' | t }}</span>
                            <span class="text-sm font-medium mb-3" *ngIf="info.networkDifficulty">
                                <tooltip-text-icon
                                    [text]="'(' + getNetworkDifficultyPercentage(info) + '%)'"
                                    [tooltip]="'miner.chance_to_find_block' | t"
                                    [split]="false"
                                />
                            </span>
                        </div>
                    </div>
                </div>
                <div>
                    <span class="text-900 font-medium cursor-pointer" pTooltip="{{info.bestSessionDiff | number:'1.0-0'}}" tooltipPosition="bottom">
                        {{info.bestSessionDiff | diffSuffix}}
                    </span>
                    <span class="text-500 text-lg">{{ 'miner.session_best' | t }}</span>
                    <span class="text-sm font-medium mb-3"> ({{ info.uptimeSeconds | dateAgo: { intervals: 2, strict:true, short:true } }})</span>
                </div>
            </div>
        </div>

        <div class="col-12" *ngIf="!info.power_fault">
            <div class="card">
                <form [formGroup]="form">
                    <div class="flex flex-nowrap justify-content-between mb-3">
                        <p-dropdown
                            [options]="dataSourceLabels(info)"
                            optionLabel="name"
                            optionValue="value"
                            formControlName="chartY1Data"
                            styleClass="w-10rem border-100 p-dropdown--small">
                        </p-dropdown>
                        <p-dropdown
                            [options]="dataSourceLabels(info)"
                            optionLabel="name"
                            optionValue="value"
                            formControlName="chartY2Data"
                            styleClass="w-10rem border-100 p-dropdown--small">
                        </p-dropdown>
                    </div>

                    <p-chart #chart id="chart" [data]="chartData" [options]="chartOptions"></p-chart>
                </form>
            </div>
        </div>

        <div class="col-12 md:col-4">
            <div class="card">
                <h4 class="text-center">{{ 'miner.power' | t }}</h4>

                <div class="mb-3">
                    <h6 class="flex justify-content-between mb-1">
                        {{ 'miner.power' | t }}<span>{{info.power}} W</span>
                    </h6>
                    <p-progressBar [value]="(info.power / info.maxPower) * 100" [styleClass]="'p-progressbar--thin'">
                        <ng-template pTemplate="content" let-value></ng-template>
                    </p-progressBar>
                </div>

                <div class="mb-3">
                    <h6 class="flex justify-content-between mb-1">
                        {{ 'miner.input_voltage' | t }}<span>{{info.voltage}} V</span>
                    </h6>
                    <div class="relative">
                        <p-progressBar [value]="(info.voltage / (info.nominalVoltage + .5)) * 100"
                            [styleClass]="'p-progressbar--thin'">
                            <ng-template pTemplate="content" let-value></ng-template>
                        </p-progressBar>

                        <!-- Conditional marker based on nominal voltage-->
                        <div class="absolute bg-white h-full top-0"
                            [style.left]="(info.nominalVoltage / (info.nominalVoltage + .5)) * 100 + '%'"
                            style="width: 3px;">
                            <small class="absolute text-white white-space-nowrap text-xs"
                                style="bottom: -1rem; transform: translateX(-50%)">
                                {{info.nominalVoltage}} V
                            </small>
                        </div>
                    </div>
                    <strong class="text-red-500" *ngIf="info.voltage < (info.nominalVoltage + .5) * 0.87">
                        {{ 'messages.danger_low_voltage' | t }}
                    </strong>
                </div>

                <div class="mb-3">
                    <h6 class="flex justify-content-between mb-1">
                        {{ 'miner.asic_frequency' | t }}<span>{{info.frequency}} MHz</span>
                    </h6>
                    <p-progressBar [value]="(info.frequency / maxFrequency) * 100" [styleClass]="'p-progressbar--thin'">
                        <ng-template pTemplate="content" let-value></ng-template>
                    </p-progressBar>
                </div>

                <div>
                    <h6 class="flex justify-content-between mb-1">
                        {{ 'miner.asic_voltage_measured' | t }}<span>{{info.coreVoltageActual}} V</span>
                    </h6>
                    <p-progressBar [value]="(info.coreVoltageActual / 1.8) * 100" [styleClass]="'p-progressbar--thin'">
                        <ng-template pTemplate="content" let-value></ng-template>
                    </p-progressBar>
                </div>
            </div>
        </div>

        <div class="col-12 md:col-4">
            <div class="card">
                <h4 class="text-center">{{ 'miner.heat' | t }}</h4>

                <div class="mb-3">
                    <h6 class="flex justify-content-between mb-1">
                        <ng-container *ngIf="info.temp2 > 0; else singleTemp">
                            {{ 'miner.asic_temperature_1' | t }}
                        </ng-container>
                        <ng-template #singleTemp>
                            {{ 'miner.asic_temperature' | t }}
                        </ng-template>
                        <span>
                            <ng-container *ngIf="info.temp > 0; else noValue">
                                {{info.temp}} &deg;C
                            </ng-container>
                        </span>
                    </h6>
                    <p-progressBar [value]="(info.temp / maxTemp) * 100" [styleClass]="'p-progressbar--thin'">
                        <ng-template pTemplate="content" let-value></ng-template>
                    </p-progressBar>

                    <strong class="text-red-500" *ngIf="info.temp >= 70">
                        {{ 'messages.danger_high_temperature' | t }}
                    </strong>
                </div>

                <div class="mb-3" *ngIf="info.temp2 > 0">
                    <h6 class="flex justify-content-between mb-1">
                        {{ 'miner.asic_temperature_2' | t }}
                        <span>
                            {{info.temp2}} &deg;C
                        </span>
                    </h6>
                    <p-progressBar [value]="(info.temp2 / maxTemp) * 100" [styleClass]="'p-progressbar--thin'">
                        <ng-template pTemplate="content" let-value></ng-template>
                    </p-progressBar>

                    <strong class="text-red-500" *ngIf="info.temp2 >= 70">
                        {{ 'messages.danger_high_temperature' | t }}
                    </strong>
                </div>

                <div class="mb-3" *ngIf="info.vrTemp > 0">
                    <h6 class="flex justify-content-between mb-1">
                        {{ 'miner.voltage_regulator_temperature' | t }}<span>{{info.vrTemp}} &deg;C</span>
                    </h6>
                    <p-progressBar [value]="(info.vrTemp / 120) * 100" [styleClass]="'p-progressbar--thin'">
                        <ng-template pTemplate="content" let-value></ng-template>
                    </p-progressBar>

                    <strong class="text-red-500" *ngIf="info.vrTemp >= 105">
                        {{ 'messages.danger_high_temperature' | t }}
                    </strong>
                </div>
            </div>
        </div>

        <div class="col-12 md:col-4">
            <div class="card">
                <h4 class="text-center">{{ 'miner.fan' | t }}</h4>

                <div class="mb-3">
                    <h6 class="flex justify-content-between mb-1">
                        {{ 'miner.fan_speed' | t }}<span>{{info.fanspeed.toFixed(1)}} %</span>
                    </h6>
                    <p-progressBar [value]="info.fanspeed" [styleClass]="'p-progressbar--thin'">
                        <ng-template pTemplate="content" let-value></ng-template>
                    </p-progressBar>
                </div>

                <div class="mb-3">
                    <h6 class="flex justify-content-between mb-1">
                        <ng-container *ngIf="info.fan2rpm > 0; else singleFan">
                            {{ 'miner.fan_1_rpm' | t }}
                        </ng-container>
                        <ng-template #singleFan>
                            {{ 'miner.fan_rpm' | t }}
                        </ng-template>
                        <span>
                            <ng-container *ngIf="info.fanrpm > 0; else noValue">
                                {{info.fanrpm}} RPM
                            </ng-container>
                        </span>
                    </h6>
                    <p-progressBar [value]="(info.fanrpm / maxRpm) * 100" [styleClass]="'p-progressbar--thin'">
                        <ng-template pTemplate="content" let-value></ng-template>
                    </p-progressBar>

                </div>

                <div *ngIf="info.fan2rpm > 0">
                    <h6 class="flex justify-content-between mb-1">
                        {{ 'miner.fan_2_rpm' | t }}
                        <span>
                            <ng-container *ngIf="info.fan2rpm > 0; else noValue">
                                {{info.fan2rpm}} RPM
                            </ng-container>
                        </span>
                    </h6>
                    <p-progressBar [value]="(info.fan2rpm / maxRpm) * 100" [styleClass]="'p-progressbar--thin'">
                        <ng-template pTemplate="content" let-value></ng-template>
                    </p-progressBar>
                </div>
            </div>
        </div>

        <div class="col-12 md:col-4">
            <div class="card">
                <div class="flex flex-nowrap justify-content-between mb-3 relative">
                    <h4 class="mb-0">
                        {{ 'miner.pool' | t }}
                        <a
                            *ngIf="(quickLink$ | async) as quickLink"
                            [href]="quickLink"
                            target="_blank"
                            rel="noopener noreferrer"
                            class="ml-1"
                            [attr.aria-label]="'actions.open_pool_dashboard_new_tab' | t"
                            [pTooltip]="'actions.open_pool_dashboard' | t"
                            tooltipPosition="top"
                        >
                            <i class="pi pi-external-link"></i>
                        </a>
                    </h4>
                    <p-dropdown
                        [options]="(pools$ | async) ?? []"
                        [(ngModel)]="activePoolLabel"
                        optionLabel="label"
                        optionValue="value"
                        (onChange)="onPoolChange($event)"
                        styleClass="border-100 p-dropdown--small absolute right-0"
                    />
                </div>

                <div class="flex flex-nowrap">
                    <div class="col-fixed-width text-500">
                        <span>{{ 'common.url' | t }}</span>
                    </div>
                    <div>
                        <tooltip-text-icon
                            text="{{ activePoolURL }}:{{activePoolPort}}"
                            tooltip="{{ info.poolConnectionInfo }}"
                        />
                    </div>
                </div>

                <div class="flex flex-nowrap ellipsis-magic overflow-hidden">
                    <div class="col-fixed-width text-500">
                        <tooltip-text-icon
                            [text]="'common.user' | t"
                            [tooltip]="activePoolUser"
                        />
                    </div>

                    <span class="start" sensitive-data>
                        {{ activePoolUser.substring(0, activePoolUser.length - 20) }}
                    </span>
                    <span class="end" sensitive-data>
                        {{ activePoolUser.substring(activePoolUser.length - 20) }}
                    </span>
                </div>

                <div class="flex flex-nowrap">
                    <div class="col-fixed-width text-500">
                        <tooltip-text-icon
                            [text]="'miner.pool_response_time' | t"
                            [tooltip]="'miner.pool_response_time_help' | t"
                        />
                    </div>
                    <div>
                        {{ info.responseTime }} ms
                    </div>
                </div>

                <div class="flex flex-nowrap">
                    <div class="col-fixed-width text-500">
                        <span>{{ 'miner.difficulty' | t }}</span>
                    </div>
                    <div>
                        {{ info.poolDifficulty }}
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12 md:col-4">
            <div class="card">
                <h4 class="white-space-nowrap overflow-hidden text-overflow-ellipsis">{{ 'miner.block_header' | t }}</h4>

                <div class="flex flex-nowrap">
                    <div class="col-fixed-width text-500">
                        <span>{{ 'miner.block_height' | t }}</span>
                    </div>
                    <div>
                        {{ info.blockHeight }}
                    </div>
                </div>

                <div class="flex flex-nowrap">
                    <div class="col-fixed-width text-500">
                        <span>{{ 'miner.difficulty' | t }}</span>
                    </div>
                    <div *ngIf="info.networkDifficulty" class="cursor-pointer" pTooltip="{{info.networkDifficulty | number:'1.0-0'}}" tooltipPosition="bottom">
                        {{ info.networkDifficulty | diffSuffix }}
                    </div>
                </div>

                <div class="flex flex-nowrap align-items-baseline">
                    <div class="col-fixed-width text-500">
                        <span>{{ 'miner.scriptsig' | t }}</span>
                    </div>
                    <div class="text-monospace">
                        {{ info.scriptsig }}
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12 md:col-4">
            <div class="card">
                <h4 class="white-space-nowrap overflow-hidden text-overflow-ellipsis">{{ 'miner.hashrate_registers' | t }}</h4>

                <ng-container *ngIf="getAsicsAmount(info) as asicAmount">
                    <table class="heatmap text-{{asicAmount <= 2 ? 'sm' : 'xs'}}">
                        <thead>
                            <tr>
                                <th *ngIf="asicAmount > 1" class="text-left">{{ 'miner.asic' | t }}</th>
                                <ng-container *ngIf="getAsicDomainsAmount(info) as asicDomainsAmount">
                                    <th *ngIf="asicDomainsAmount > 0" [attr.colspan]="asicDomainsAmount">
                                        {{ asicDomainsAmount == 1 ? ('miner.domain' | t) : ('miner.domains' | t) }}
                                    </th>
                                </ng-container>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="cursor-pointer" *ngFor="let asic of info.hashrateMonitor.asics; let i = index"
                                    [pTooltip]="asicAmount > 1
                                        ? ('miner.asic_error_count_with_index' | t:{ index: i + 1, count: asic.errorCount })
                                        : ('miner.asic_error_count' | t:{ count: asic.errorCount })"
                                    tooltipPosition="bottom">
                                <td *ngIf="asicAmount > 1" class="text-500 text-left">
                                    {{ i + 1 }}
                                </td>
                                <td *ngFor="let domain of asic.domains"
                                    [style.background]="getHeatmapColor(info, domain)"
                                    [style.height]="(asicAmount <= 2 ? '2rem' : null)"
                                    class="text-center">
                                    <span class="text-xs">{{ domain | hashSuffix }}</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </ng-container>
            </div>
        </div>
    </div>

    <app-confetti *ngIf="info.blockFound"></app-confetti>
</ng-container>
